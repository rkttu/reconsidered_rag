"""
01_download_model.py
Hugging Faceì—ì„œ Microsoft Phi-4 mini ONNX ëª¨ë¸ì„ ë‹¤ìš´ë¡œë“œí•˜ëŠ” ëª¨ë“ˆ
"""

import os
import sys
from pathlib import Path
from huggingface_hub import snapshot_download, hf_hub_download
from tqdm import tqdm


# ëª¨ë¸ ì„¤ì •
MODEL_REPO_ID = "microsoft/phi-4-onnx"
# CPUìš© int4 ì–‘ìí™” ëª¨ë¸
MODEL_SUBFOLDER = "cpu_and_mobile/cpu-int4-rtn-block-32-acc-level-4"

# ê¸°ë³¸ ë‹¤ìš´ë¡œë“œ ê²½ë¡œ
DEFAULT_MODEL_DIR = Path(__file__).parent / "models" / "phi-4-onnx"


def download_phi4_mini_onnx(
    model_dir: Path = DEFAULT_MODEL_DIR,
    force_download: bool = False,
) -> Path:
    """
    Hugging Faceì—ì„œ Phi-4 mini ONNX ëª¨ë¸ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
    
    Args:
        model_dir: ëª¨ë¸ì„ ì €ì¥í•  ë””ë ‰í„°ë¦¬ ê²½ë¡œ
        force_download: Trueì´ë©´ ê¸°ì¡´ ëª¨ë¸ì´ ìˆì–´ë„ ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œ
        
    Returns:
        ë‹¤ìš´ë¡œë“œëœ ëª¨ë¸ ë””ë ‰í„°ë¦¬ ê²½ë¡œ
    """
    model_dir = Path(model_dir)
    
    # ì´ë¯¸ ë‹¤ìš´ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
    model_file = model_dir / "model.onnx"
    if model_file.exists() and not force_download:
        print(f"âœ… ëª¨ë¸ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤: {model_dir}")
        return model_dir
    
    print(f"ğŸ“¥ Phi-4 mini ONNX ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹œì‘...")
    print(f"   ë¦¬í¬ì§€í† ë¦¬: {MODEL_REPO_ID}")
    print(f"   ì„œë¸Œí´ë”: {MODEL_SUBFOLDER}")
    print(f"   ì €ì¥ ìœ„ì¹˜: {model_dir}")
    
    # ë””ë ‰í„°ë¦¬ ìƒì„±
    model_dir.mkdir(parents=True, exist_ok=True)
    
    try:
        # snapshot_downloadë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • í´ë”ë§Œ ë‹¤ìš´ë¡œë“œ
        downloaded_path = snapshot_download(
            repo_id=MODEL_REPO_ID,
            allow_patterns=[f"{MODEL_SUBFOLDER}/*"],
            local_dir=model_dir.parent / "phi-4-onnx-temp",
        )
        
        # ë‹¤ìš´ë¡œë“œëœ ì„œë¸Œí´ë”ë¥¼ ìµœì¢… ìœ„ì¹˜ë¡œ ì´ë™
        source_path = Path(downloaded_path) / MODEL_SUBFOLDER
        if source_path.exists():
            import shutil
            # ê¸°ì¡´ ë””ë ‰í„°ë¦¬ê°€ ìˆìœ¼ë©´ ì‚­ì œ
            if model_dir.exists():
                shutil.rmtree(model_dir)
            # ì„œë¸Œí´ë”ë¥¼ ìµœì¢… ìœ„ì¹˜ë¡œ ì´ë™
            shutil.move(str(source_path), str(model_dir))
            # ì„ì‹œ ë””ë ‰í„°ë¦¬ ì •ë¦¬
            temp_dir = model_dir.parent / "phi-4-onnx-temp"
            if temp_dir.exists():
                shutil.rmtree(temp_dir)
        
        print(f"\nâœ… ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: {model_dir}")
        
        # ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ ëª©ë¡ ì¶œë ¥
        print("\nğŸ“ ë‹¤ìš´ë¡œë“œëœ íŒŒì¼:")
        for file in sorted(model_dir.iterdir()):
            size_mb = file.stat().st_size / (1024 * 1024)
            print(f"   - {file.name} ({size_mb:.2f} MB)")
            
        return model_dir
        
    except Exception as e:
        print(f"\nâŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: {e}")
        raise


def get_model_path() -> Path:
    """
    ë‹¤ìš´ë¡œë“œëœ ëª¨ë¸ì˜ ê²½ë¡œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    ëª¨ë¸ì´ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
    
    Returns:
        ëª¨ë¸ ë””ë ‰í„°ë¦¬ ê²½ë¡œ
    """
    model_dir = DEFAULT_MODEL_DIR
    if not (model_dir / "model.onnx").exists():
        print("âš ï¸ ëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")
        download_phi4_mini_onnx(model_dir)
    return model_dir


def main():
    """ë©”ì¸ í•¨ìˆ˜: ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰"""
    import argparse
    
    parser = argparse.ArgumentParser(
        description="Hugging Faceì—ì„œ Phi-4 mini ONNX ëª¨ë¸ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤."
    )
    parser.add_argument(
        "--model-dir",
        type=Path,
        default=DEFAULT_MODEL_DIR,
        help=f"ëª¨ë¸ ì €ì¥ ë””ë ‰í„°ë¦¬ (ê¸°ë³¸ê°’: {DEFAULT_MODEL_DIR})",
    )
    parser.add_argument(
        "--force",
        action="store_true",
        help="ê¸°ì¡´ ëª¨ë¸ì´ ìˆì–´ë„ ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œ",
    )
    
    args = parser.parse_args()
    
    download_phi4_mini_onnx(
        model_dir=args.model_dir,
        force_download=args.force,
    )


if __name__ == "__main__":
    main()
